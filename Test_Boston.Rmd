---
title: "Test_Boston"
author: "Kevin"
date: "4/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
library(tidyr)
results_2001 <- read_csv("Data/results_2001.csv")
results_2002 <- read_csv("Data/results_2002.csv")
results_2003 <- read_csv("Data/results_2003.csv")
results_2004 <- read_csv("Data/results_2004.csv")
results_2005 <- read_csv("Data/results_2005.csv")
results_2006 <- read_csv("Data/results_2006.csv")
results_2007 <- read_csv("Data/results_2007.csv")
results_2008 <- read_csv("Data/results_2008.csv")
results_2009 <- read_csv("Data/results_2009.csv")
results_2010 <- read_csv("Data/results_2010.csv")
results_2011 <- read_csv("Data/results_2011.csv")
results_2012 <- read_csv("Data/results_2012.csv")
results_2013 <- read_csv("Data/results_2013.csv")
results_2014 <- read_csv("Data/results_2014.csv")
results_2015 <- read_csv("Data/marathon_results_2015.csv")
results_2016 <- read_csv("Data/marathon_results_2016.csv")
results_2017 <- read_csv("Data/marathon_results_2017.csv")
all <- bind_rows(mutate(results_2001, year = "2001"), 
                 mutate(results_2002, year = "2002"),
                 mutate(results_2003, year = "2003"),
                 mutate(results_2004, year = "2004"),
                 mutate(results_2005, year = "2005"),
                 mutate(results_2006, year = "2006"),
                 mutate(results_2007, year = "2007"),
                 mutate(results_2008, year = "2008"),
                 mutate(results_2009, year = "2009"),
                 mutate(results_2010, year = "2010"),
                 mutate(results_2011, year = "2011"),
                 mutate(results_2012, year = "2012"))
  all <- all %>%
    select(age, gender, city, state, country, year)
  
  new <-bind_rows(
    (results_2013 %>%
      mutate(year = "2013") %>%
     select(age, gender, city, state, country, year)),
                 (results_2014 %>%
      mutate(year = "2014") %>%
     select(age, gender, city, state, country, year)),
                 (results_2015 %>%
      mutate(year = "2015") %>%
     select(age = Age, gender = "M/F", city = City, state = State, country = Country, year)),
                 (results_2016 %>%
      mutate(year = "2016") %>%
     select(age = Age, gender = "M/F", city = City, state = State, country = Country, year)),
                 (results_2017 %>%
      mutate(year = "2017") %>%
     select(age = Age, gender = "M/F", city = City, state = State, country = Country, year)))

all <- bind_rows(all, new)

library(ggmap)
library(maps)
library(leaflet)
states <- map_data("state")
state_abb <- read_csv("Data/states.csv")
state_abb <- state_abb %>%
  mutate(State = tolower(State))
states <- left_join(states, state_abb, by = c("region" = "State"))
all_counts <- all %>%
  group_by(year, state, gender) %>%
  summarise(counts = n())
states <- inner_join(states, all_counts, by = c("Abbreviation" = "state"))

summary_1 <- all %>%
  group_by(year) %>%
  summarise(distinct_countries = n_distinct(country))
summary_2 <- all %>%
  group_by(year, gender) %>%
  summarise(count = n())
summary_2 <- spread(summary_2, 
                    key = gender, 
                    value = count)
summary <- left_join(summary_2, summary_1, by = c("year" = "year"))
summary <- mutate(summary, total = M + F)

country_counts <- all %>%
  group_by(year, country) %>%
  summarise(counts = n())

ggplot(data = states) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill = counts), color = "white") + 
  coord_map() + 
  theme_void()

#shiny stuff
library(shiny)
library(dplyr)
library(ggplot2)
server <- function(input, output) {
  output$map <- renderPlot({
    states <- filter(states, year %in% input$year, gender %in% input$gender)
    ggplot(data = states) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill = counts), color = "white") + 
  coord_map() + 
  theme_void()
  })
  
  
  output$table <- DT::renderDataTable({
    req(input$vars)
    data_react <- select(all, input$vars)
    DT::datatable(data = data_react, rownames = FALSE)
  })
  
  output$summary <- DT::renderDataTable({
    req(input$sumyear)
    summ_react <- filter(summary, year %in% input$sumyear)
    DT::datatable(data = summ_react, rownames = FALSE)
  })
}

  ui <- fluidPage(
    titlePanel("Boston Marathon"),
    tabsetPanel(type = "tabs",
                  tabPanel(title = "Plot",
    sidebarLayout(
      
      sidebarPanel(
        helpText("Boston Marathon finishers"),
        
        checkboxGroupInput(inputId = "year",
                           label = "Which year(s) do you want to see?",
                           choices = unique(states$year),
                           selected = c("2001")),
        
        checkboxGroupInput(inputId = "gender",
                           label = "Which gender do you want to see?",
                           choices = unique(states$gender),
                           selected = c("M"))),
      mainPanel(
        plotOutput(outputId = "map")
      ) 
      )),
                tabPanel(title = "Data Table",
                         sidebarLayout(
      sidebarPanel(
        helpText("Boston Marathon finshers"),
                 
        checkboxGroupInput(inputId = "vars",
                           label = "Which variable(s) do you want to see?",
                           choices = list("Age" = "age",
                                          "Gender" = "gender",
                                          "City" = "city",
                                          "State" = "state",
                                          "Country" = "country",
                                          "Year" = "year"),
                           selected = c("age", 
                                        "gender",
                                        "city", 
                                        "state",
                                        "country",
                                        "year"))),
      mainPanel(
        DT::dataTableOutput(outputId = "table"))
      )
      ),
          tabPanel(title = "Summary",
                   sidebarLayout(
      
      sidebarPanel(
        helpText("Boston Marathon finishers"),
        
        checkboxGroupInput(inputId = "sumyear",
                           label = "Which year(s) do you want to see?",
                           choices = summary$year,
                           selected = summary$year)),
      mainPanel(
        DT::dataTableOutput(outputId = "summary")
      )
    ))
  )
  )
  
shinyApp(ui = ui, server = server)
```

